version: '3.7'
services:
  test:
    build:
      context: ../..
      dockerfile: ./packages/model-runner/Dockerfile
      target: test

  release:
    build:
      context: ../..
      dockerfile: ./packages/model-runner/Dockerfile
      target: release
    # This is set this way to make things easier in the Actions workflows.
    image: image

  run-model:
    build:
      context: ../..
      dockerfile: ./packages/model-runner/Dockerfile
      target: release
    environment:
      - GITHUB_RUN_ID=local
      - MODEL_RUNNER_OUTPUT_DIR=/data/output
      - AZURE_STORAGE_ACCOUNT
      - AZURE_STORAGE_CONTAINER
      - DOCKER_USER
      - DOCKER_PASSWORD
      - HOST_WORK_DIR=${PWD}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./input:/data/input:rw
      - ./output:/data/output:rw
      - ./log:/data/log:rw
      - ./test:/data/test:rw
    command: /data/test/test-job-mrc-ide-covidsim.json

  remote-image:
    image: ghcr.io/${GITHUB_REPO:-covid-policy-modelling/model-runner}/model-runner:main
    environment:
      - GITHUB_RUN_ID=local
      - MODEL_RUNNER_OUTPUT_DIR=/data/output
      - AZURE_STORAGE_ACCOUNT
      - AZURE_STORAGE_CONTAINER
      - DOCKER_USER
      - DOCKER_PASSWORD
    tty: true
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./input:/data/input:rw
      - ./output:/data/output:rw
      - ./log:/data/log:rw
      - ./test:/data/test:rw
    command: /data/test/test-job-mrc-ide-covidsim.json
